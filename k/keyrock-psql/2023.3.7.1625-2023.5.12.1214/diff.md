# Comparing `tmp/keyrock_psql-2023.3.7.1625-py3-none-any.whl.zip` & `tmp/keyrock_psql-2023.5.12.1214-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,18 +1,18 @@
-Zip file size: 14495 bytes, number of entries: 16
--rw-r--r--  2.0 unx       80 b- defN 23-Mar-07 16:24 keyrock_psql/__init__.py
--rw-r--r--  2.0 unx       31 b- defN 23-Mar-07 16:24 keyrock_psql/migrator/__init__.py
--rw-r--r--  2.0 unx     2204 b- defN 23-Mar-07 16:24 keyrock_psql/migrator/migrator.py
--rw-r--r--  2.0 unx      344 b- defN 23-Mar-07 16:24 keyrock_psql/psql/__init__.py
--rw-r--r--  2.0 unx    15195 b- defN 23-Mar-07 16:24 keyrock_psql/psql/cmd_gen.py
--rw-r--r--  2.0 unx     9082 b- defN 23-Mar-07 16:24 keyrock_psql/psql/connection.py
--rw-r--r--  2.0 unx      773 b- defN 23-Mar-07 16:24 keyrock_psql/psql/cursor.py
--rw-r--r--  2.0 unx     2732 b- defN 23-Mar-07 16:24 keyrock_psql/psql/diff.py
--rw-r--r--  2.0 unx      350 b- defN 23-Mar-07 16:24 keyrock_psql/psql/exc.py
--rw-r--r--  2.0 unx     8587 b- defN 23-Mar-07 16:24 keyrock_psql/psql/structure.py
--rw-r--r--  2.0 unx     7886 b- defN 23-Mar-07 16:24 keyrock_psql/psql/test_psql.py
--rw-r--r--  2.0 unx     1263 b- defN 23-Mar-07 16:24 keyrock_psql/psql/util.py
--rw-r--r--  2.0 unx      124 b- defN 23-Mar-07 16:25 keyrock_psql-2023.3.7.1625.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Mar-07 16:25 keyrock_psql-2023.3.7.1625.dist-info/WHEEL
--rw-r--r--  2.0 unx       13 b- defN 23-Mar-07 16:25 keyrock_psql-2023.3.7.1625.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     1366 b- defN 23-Mar-07 16:25 keyrock_psql-2023.3.7.1625.dist-info/RECORD
-16 files, 50122 bytes uncompressed, 12219 bytes compressed:  75.6%
+Zip file size: 14879 bytes, number of entries: 16
+-rw-r--r--  2.0 unx       80 b- defN 23-May-12 12:13 keyrock_psql/__init__.py
+-rw-r--r--  2.0 unx       31 b- defN 23-May-12 12:13 keyrock_psql/migrator/__init__.py
+-rw-r--r--  2.0 unx     3820 b- defN 23-May-12 12:13 keyrock_psql/migrator/migrator.py
+-rw-r--r--  2.0 unx      344 b- defN 23-May-12 12:13 keyrock_psql/psql/__init__.py
+-rw-r--r--  2.0 unx    15250 b- defN 23-May-12 12:13 keyrock_psql/psql/cmd_gen.py
+-rw-r--r--  2.0 unx     9012 b- defN 23-May-12 12:13 keyrock_psql/psql/connection.py
+-rw-r--r--  2.0 unx      773 b- defN 23-May-12 12:13 keyrock_psql/psql/cursor.py
+-rw-r--r--  2.0 unx     2732 b- defN 23-May-12 12:13 keyrock_psql/psql/diff.py
+-rw-r--r--  2.0 unx      350 b- defN 23-May-12 12:13 keyrock_psql/psql/exc.py
+-rw-r--r--  2.0 unx     8587 b- defN 23-May-12 12:13 keyrock_psql/psql/structure.py
+-rw-r--r--  2.0 unx     7886 b- defN 23-May-12 12:13 keyrock_psql/psql/test_psql.py
+-rw-r--r--  2.0 unx     1322 b- defN 23-May-12 12:13 keyrock_psql/psql/util.py
+-rw-r--r--  2.0 unx      125 b- defN 23-May-12 12:14 keyrock_psql-2023.5.12.1214.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-12 12:14 keyrock_psql-2023.5.12.1214.dist-info/WHEEL
+-rw-r--r--  2.0 unx       13 b- defN 23-May-12 12:14 keyrock_psql-2023.5.12.1214.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     1370 b- defN 23-May-12 12:14 keyrock_psql-2023.5.12.1214.dist-info/RECORD
+16 files, 51787 bytes uncompressed, 12595 bytes compressed:  75.7%
```

## zipnote {}

```diff
@@ -30,20 +30,20 @@
 
 Filename: keyrock_psql/psql/test_psql.py
 Comment: 
 
 Filename: keyrock_psql/psql/util.py
 Comment: 
 
-Filename: keyrock_psql-2023.3.7.1625.dist-info/METADATA
+Filename: keyrock_psql-2023.5.12.1214.dist-info/METADATA
 Comment: 
 
-Filename: keyrock_psql-2023.3.7.1625.dist-info/WHEEL
+Filename: keyrock_psql-2023.5.12.1214.dist-info/WHEEL
 Comment: 
 
-Filename: keyrock_psql-2023.3.7.1625.dist-info/top_level.txt
+Filename: keyrock_psql-2023.5.12.1214.dist-info/top_level.txt
 Comment: 
 
-Filename: keyrock_psql-2023.3.7.1625.dist-info/RECORD
+Filename: keyrock_psql-2023.5.12.1214.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## keyrock_psql/migrator/migrator.py

```diff
@@ -5,56 +5,115 @@
 from .. import psql
 
 logger = logging.getLogger(__name__)
 #logger.setLevel(logging.INFO)
 logger.setLevel(logging.DEBUG)
 
 
+default_user_types = {
+    "user_types": {
+        "float": {
+            "type": "real"
+        },
+        "varchar": {
+            "type": "character varying"
+        },
+        "id": {
+            "type": "bigint",
+            "is_identity": True,
+            "identity_start": 100000
+        },
+        "id_ref": {
+            "type": "bigint",
+            "allow_null": True
+        },
+        "hash_key": {
+            "type": "character varying",
+            "size": 64
+        }
+    }
+}
+
+
 class Migrator():
     def __init__(self, db_config):
         self.db_config = db_config
 
-    def update(self, target_schema):
+    def provision(self) -> bool:
+        logger.info(f"Migrator.provision")
+        try:
+            target_schema = {
+                'schemas': {
+                    self.db_config['schema']: {}
+                }
+            }
+            self.update(target_schema)
+        except e as Exception:
+            logger.error(str(e))
+            return False
+        return True
+
+    def update(self, target_schema, use_default_user_types=True):
         logger.info(f"Migrator.update")
+        if use_default_user_types:
+            logger.info(f"applying default types")
+            new_target_schema = default_user_types.copy()
+            json_util.deep_update(new_target_schema, target_schema)
+            target_schema = new_target_schema
 
         logger.info(f"wait for psql server: {self.db_config['host']}")
         psql.wait_for_server(self.db_config, timeout_sec=15)
 
         debug_db_name = f"{self.db_config['host']}:{self.db_config['db']}"
         if psql.database_exists(self.db_config):
             logger.info(f"database exists: {debug_db_name}")
         else:
             logger.info(f"database doesn't exist: {debug_db_name}")
             logger.info(f"creating database: {debug_db_name}")
             psql.create_database(self.db_config)
 
+        #logger.debug("target_schema:")
+        #logger.debug(json.dumps(target_schema, indent=2))
+
         conn = psql.Connection(self.db_config)
         current_schema = psql.get_structure(conn)
 
         structure_diff = psql.catalog_diff(current_schema, target_schema)
         if structure_diff['op'] is not None:
             logger.debug("changes applied:")
             logger.debug(json.dumps(json_util.strip_unchanged(structure_diff), indent=2))
 
         cmd_list = psql.diff_to_cmd_list(structure_diff)
         if len(cmd_list) > 0:
             logger.debug("command list:")
             logger.debug(json.dumps(cmd_list, indent=2))
 
+        success = True
         error_list = conn.exec_cmd_list(cmd_list)
         if len(error_list) > 0:
+            success = False
             logger.error("errors encountered:")
             logger.error(json.dumps(error_list, indent=2))
 
         #
         # Verify that the new structure matches the intended target
         #
         updated_schema = psql.get_structure(conn)
         verify_diff = psql.catalog_diff(updated_schema, target_schema)
         if verify_diff['op'] is not None:
+            success = False
             logger.error(f"target schema not completely applied:")
             logger.error(json.dumps(json_util.strip_unchanged(verify_diff), indent=2))
 
-        cmd_list = psql.diff_to_cmd_list(verify_diff)
-        if len(cmd_list) > 0:
+        verify_cmd_list = psql.diff_to_cmd_list(verify_diff)
+        if len(verify_cmd_list) > 0:
+            success = False
             logger.error(f"delta command list is not empty:")
-            logger.error(json.dumps(cmd_list, indent=2))
+            logger.error(json.dumps(verify_cmd_list, indent=2))
+
+        return {
+            'success': success,
+            'error_list': error_list,
+            #'structure_diff': structure_diff,
+            'cmd_list': cmd_list,
+            'verify_cmd_list': verify_cmd_list
+        }
```

## keyrock_psql/psql/cmd_gen.py

```diff
@@ -47,15 +47,15 @@
 
     def parse_diff(self, group_node, cmd_list, context):
         group_op = group_node['op']
         if group_op == 'dict':
             for item_key, item_node in group_node['diff'].items():
                 self.write(item_key, item_node, cmd_list, context)
         elif group_op == 'add':
-            raise NotImplementedError('group add implemented')
+            raise NotImplementedError('group add not implemented')
         elif group_op == 'del':
             raise NotImplementedError('group del not implemented')
 
     def update_context(self, item_key, context):
         context[self.context_key] = item_key
 
     def write(self, item_key, item_node, cmd_list, context):
@@ -214,17 +214,18 @@
         if default_val_op == 'del':
             cmd_str = (
                 f"ALTER TABLE {context['schema']}.{context['table']}"
                 f" ALTER COLUMN {item_key} DROP DEFAULT"
             )
             cmd_list.append(cmd_str)
         elif default_val_op is not None:
+            default_val = util.to_sql(item_data['default'])
             cmd_str = (
                 f"ALTER TABLE {context['schema']}.{context['table']}"
-                f" ALTER COLUMN {item_key} SET DEFAULT {item_data['default']}"
+                f" ALTER COLUMN {item_key} SET DEFAULT {default_val}"
             )
             cmd_list.append(cmd_str)
 
         super().write_dict(item_key, item_node, cmd_list, context)
 
     def update_type(self, item_key, item_data, cmd_list, context):
         cmd_str = (
```

## keyrock_psql/psql/connection.py

```diff
@@ -207,21 +207,20 @@
             id = cursor.fetchone()[key]
             id_list.append(id)
         return id_list
 
     @handle_commit
     def update(self, table_name, row_data, id=None, key='id', commit=True):
         if id is None:
+            row_data = row_data.copy()
             id = row_data[key]
+            del row_data[key]
 
         val_list = []
         for col, val in row_data.items():
-            if (col == key) and (val == id):
-                # Ignore updating the id (if included and unchanged)
-                continue
             val_list.append(f"{col}={util.to_sql(val)}")
         val_list_str = ', '.join(val_list)
 
         cmd_str = (
             f"UPDATE {table_name}"
             f" SET {val_list_str}"
             f" WHERE {util.sql_eq(key, id)}"
```

## keyrock_psql/psql/util.py

```diff
@@ -37,14 +37,16 @@
 def convert_default(str_val):
     ''' For reading in default values from the db '''
     if str_val is None:
         return None
     str_lower = str_val.lower()
     if str_lower == 'null':
         return None
+    if str_lower.startswith('null::'):
+        return None
     if str_lower == 'false':
         return False
     if str_lower == 'true':
         return True
     return str_val
```

## Comparing `keyrock_psql-2023.3.7.1625.dist-info/RECORD` & `keyrock_psql-2023.5.12.1214.dist-info/RECORD`

 * *Files 12% similar despite different names*

```diff
@@ -1,16 +1,16 @@
 keyrock_psql/__init__.py,sha256=_MrDcgw2uWGHFLpcHkdwO8FKsL1DhbUHqyPFxQjCdNE,80
 keyrock_psql/migrator/__init__.py,sha256=g0g5Px5EMGPPmhVj1nkRmj371daVcydVCjey5i07RTo,31
-keyrock_psql/migrator/migrator.py,sha256=_ti1vE3m6aMhhlBPuNd6gEkgpf-eK34Ak7s3TJwYLjQ,2204
+keyrock_psql/migrator/migrator.py,sha256=uI2brXZEpaAzKLOsEWxrx7uueuA_D8EEvG8Zts91Dv4,3820
 keyrock_psql/psql/__init__.py,sha256=sc7woq2BxzLIff0LT3QnlCFrlKgmEsyguOvUvPmRJb8,344
-keyrock_psql/psql/cmd_gen.py,sha256=PFzNP_4O_RxkEkk1FPfYZE5zYYMmgGcVU_KN1oSswrk,15195
-keyrock_psql/psql/connection.py,sha256=bf1ke5piLEayo9EfAZ7jtT1eFXeaZsv5xSXeOPEbrig,9082
+keyrock_psql/psql/cmd_gen.py,sha256=qwUabK0_wSMXRYiNk-oQdH4KaP9u15wmajIDoJLjUJo,15250
+keyrock_psql/psql/connection.py,sha256=QsO16TZeEaqQp_Uqd7aA9QJLKOhdM20PgQmzUMYDI1M,9012
 keyrock_psql/psql/cursor.py,sha256=fFRYkvSU4EG0q2ZXu9ZqyZM-BCZ5mPD9Qp8ZqY2OSf4,773
 keyrock_psql/psql/diff.py,sha256=ogeZFJwoCi0GTFq5IbTjEf1ZCqMXzVfLlkuTUc2Wwzk,2732
 keyrock_psql/psql/exc.py,sha256=m60oIb457ZfAq03voil4R6JbsoB5dCgDsL04ZiK4LLk,350
 keyrock_psql/psql/structure.py,sha256=zkckNQyEMJwjDuWHxEpwa-7xDJAt03hlaWYVslhmE38,8587
 keyrock_psql/psql/test_psql.py,sha256=gPg-FCW5KgQxGEklGegjV-CAl8yiZ31M4XdinLil5pQ,7886
-keyrock_psql/psql/util.py,sha256=55GWaTHQ0KjCu51YfkQoKfpStIDrmP91Ost7Nu3kyJ8,1263
-keyrock_psql-2023.3.7.1625.dist-info/METADATA,sha256=0FtPsR4V2p2lDHJUersIoPe8nSLO3wd6iq6qeYnRKT8,124
-keyrock_psql-2023.3.7.1625.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
-keyrock_psql-2023.3.7.1625.dist-info/top_level.txt,sha256=DTPcRcG81_hJzQhcZdyxaUe78fvrfMzdzIm0P6fze4E,13
-keyrock_psql-2023.3.7.1625.dist-info/RECORD,,
+keyrock_psql/psql/util.py,sha256=jyKkryVj2YNWKmfJlcslja38ftk-CkX349g_2UG306M,1322
+keyrock_psql-2023.5.12.1214.dist-info/METADATA,sha256=2vuz5BF0eHPJzJFHTe-VmU_s8nuh4aya3TOrZdZ3D0g,125
+keyrock_psql-2023.5.12.1214.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+keyrock_psql-2023.5.12.1214.dist-info/top_level.txt,sha256=DTPcRcG81_hJzQhcZdyxaUe78fvrfMzdzIm0P6fze4E,13
+keyrock_psql-2023.5.12.1214.dist-info/RECORD,,
```

